//função executada ao carregar a página, contém as funções que vão carregar as aplicações e modais.
window.onload = async function () {
    var aplicacoes = get('/aplicacoes');
    aplicacoes = JSON.parse(aplicacoes);
    for (aplicacao in aplicacoes) {
        this.addAplicacao(aplicacoes[aplicacao]);
        this.addModal(aplicacoes[aplicacao]);
    }
};

//função responsável por fazer qualquer requisição GET ao banco de dados
function get(theUrl) {
    var xmlHttp = new XMLHttpRequest();
    xmlHttp.open("GET", theUrl, false); // false for synchronous request
    xmlHttp.send(null);
    return xmlHttp.responseText;
}

//adiciona cada aplicação na tela
function addAplicacao(aplicacao) {
    div = document.createElement('div');
    div.id = aplicacao.id;
    div.innerHTML = `
    <div class="//zoom col-md-3 col-sm-6 vidros-item">
        <a class="vidros-link largura-adm" data-toggle="modal" href="#modalaplicacoes`+ aplicacao.id + `">
            <div class="img-fluid imgSlider fit-image" style="background-image: url(`+ aplicacao.imagem + `)">
                <h4 class="texto-produtos">`+ aplicacao.nome + `</h4 class="texto-produtos">
            </div>
        </a>
    </div>
    <div class="text-center"><a href="#expand`+ aplicacao.id + `" data-toggle="collapse" style="color: black; font-size:15px; margin-top:-25px"><i class="fas fa-chevron-down"></i></a></div>

    <div id="expand`+ aplicacao.id + `" class="collapse" style="">
        <div style="margin-top: 10px" class="text-center">
        <div style="margin-bottom: 5px" ><a onClick="editar(`+ aplicacao.id + `,` + `'` + aplicacao.nome + `',` + `'` + aplicacao.imagem + `'` + `)" class="btn btn-primary btn-sm textoBranco" style="cursor: pointer;"><i class="fas fa-edit"></i> Editar</a></div>
        <div><a onClick="deletar(`+ aplicacao.id + `, 'aplicacao')" class="btn btn-primary btn-sm textoBranco" style="cursor: pointer; background-color:#d11a2a !important; border-color:#d11a2a !important"><i class="fas fa-trash-alt"></i> Deletar</a></div>
    </div>
        
    `;

    document.getElementById('getAplicacoes').appendChild(div);
}

//cada aplicação abre um modal que contém várias imagens, essa função adiciona o modal de cada aplicação
function addModal(aplicacao) {
    div = document.createElement('div');
    varhtml = `
    <div class="vidros-modal modal fade" id="modalaplicacoes`+ aplicacao.id + `" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="close-modal" data-dismiss="modal">
            <i class="fas fa-times externo"></i>
        </div>
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="container small-modal-container">
                    <div class="modal-body">
                        <div id="botoes`+ aplicacao.id + `">
                            <div id="addBotao`+ aplicacao.id + `">
                                <a onClick="movimentarImagem(`+ aplicacao.id + `)" class="btn btn-primary btn-md textoBranco"
                                style="float: right; margin-top: -50px; margin-bottom: 10px; cursor: pointer;"><i class="fas fa-arrows-alt"></i>
                                Movimentar</a>
                            </div>
                        </div>
                        <h2 class="text-uppercase text-center">`+ aplicacao.nome + `</h2>
                        <div class="container">
                            <div class="row justify-content-center" id="getImagens`+ aplicacao.id + `">
                                `+ addImagens(aplicacao.id) + `
                            </div>
                        </div>

                        <button class="btn btn-primary" data-dismiss="modal" type="button">
                            <i class="fas fa-times"></i>
                            Fechar</button>
                    </div>

                </div>
            </div>
        </div>
    </div>`
    div.innerHTML = varhtml;
    console.log(div.innerHTML);
    document.getElementById('getModal').appendChild(div);
}

//adiciona as imagens dentro de cada modal
function addImagens(id) {
    var imagens = get('/imagens_aplicacoes/0/' + id);
    imagens = JSON.parse(imagens);
    console.log(imagens);
    var html = '';
    for (imagem in imagens) {
        console.log(imagens[imagem]);
        html += `
        <div class="col-lg-4 col-md-4 col-sm-6 col-xs-12 vidros-item" style="margin-bottom: 10px" id="`+ imagens[imagem].id + `">
            <a class="open-img fill" data-toggle="modal" href="#imgModal`+ imagens[imagem].id + `"><img class="img-produtos img-fluid" src="` + imagens[imagem].imagem + `" alt=""></a>
            <div style=" margin-top:-20px"><a href="#expand`+ imagens[imagem].id + `" data-toggle="collapse" style="color: black; font-size:15px;"><i class="fas fa-chevron-down"></i></a></div>
            <div id="expand`+ imagens[imagem].id + `" class="collapse" style="">
            <div style="margin-top: 10px" class="text-center"><a onClick="deletar(`+ imagens[imagem].id + `, 'imagem')" class="btn btn-primary btn-sm textoBranco" style="cursor: pointer; background-color:#d11a2a !important; border-color:#d11a2a !important"><i class="fas fa-trash-alt"></i> Deletar</a></div>
        </div>
        </div>
        `;
        this.addModalImagem(imagens[imagem]);
    }
    return html;
}

//dentro do modal, cada imagem possui um outro modal que a exibe de forma ampliada, essa função os cria
function addModalImagem(imagem) {
    div2 = document.createElement('div');
    div2.innerHTML = `
    <div class="vidros-modal img-modal modal fade" id="imgModal`+ imagem.id + `" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
        aria-hidden="true">
        <div class="close-modal" data-dismiss="modal">
            <i class="fas fa-times externo"></i>
        </div>
        <div class="modal-dialog">
            <div class="modal-body">
                <div class="row justify-content-center">
                <span class="height-ajust"></span><img class="img-open-modal" src="`+ imagem.imagem + `">
                </div>
            </div>
        </div>
    </div>
    `
    document.getElementById('getModal').appendChild(div);
}

//envia os parâmetros de uma aplicação para a tela de edição pela url
function editar(idv, titulov, textov, imagemv) {
    document.location.href = `editar_produto.html?id=` + idv + `&titulo=` + titulov + `&texto=` + textov + `&imagem=` + imagemv;
}

//deleta aplicações e imagens
function deletar(id, tipo) {
    if (tipo == "imagem") {
        var url = "/imagens_aplicacoes/" + id;
        var text = "Após deletada a imagem não poderá ser recuperada. Deseja mesmo deletar?";
        var ok = "Imagem deletada com sucesso!";
    }
    else {
        var url = "/aplicacoes/" + id;
        var text = "Ao deletar a aplicação todas suas imagens serão deletadas juntas. Deseja mesmo deletar?";
        var ok = "Aplicação deletada com sucesso!";

    }
    var xhr = new XMLHttpRequest();
    xhr.open("DELETE", url, true);
    if (confirm(text)) {
        txt = "You pressed OK!";
        xhr.onload = function () {
            var produtos = JSON.parse(xhr.responseText);
            if (xhr.readyState == 4 && xhr.status == "200") {
                console.table(produtos);
                document.location.href = "admin_aplicacoes";
                alert(ok)
            } else {
                console.error(produtos);
            }
        }
        xhr.send(null);
    }
}

//incicializa o JQuery-ui sortable desabilitado
$(function () {
    $("#getAplicacoes").sortable({
        disabled: true
    });

    $("#getAplicacoes").disableSelection();
});

//habilita o JQuery-ui sortable
function movimentar() {
    const div = document.createElement('div');
    div.id = "addBotao";
    div.innerHTML = `
<a class="btn btn-primary btn-md botao-oco" style="margin-right: 10px;" href="admin_aplicacoes">
Cancelar</a>
<a class="btn btn-primary btn-md textoBranco" style="cursor: pointer; background-color: #32CD32 !important; border-color: #32CD32 !important" onClick="salvar()"><i class="fas fa-check-circle"></i> Salvar</a>
`
    document.getElementById("addBotao").remove();
    document.getElementById("botoes").appendChild(div);
    $("#getAplicacoes").sortable("option", "disabled", false);
}

//salva a nova ordem das aplicacoes
function salvar() {
    var sorted = $("#getAplicacoes").sortable("toArray");
    console.log(sorted);
    for (var i = 0; i < sorted.length; i++) editarPosicao(sorted[i], i + 1);
    window.alert("Aplicações movidas com sucesso!");
    const div = document.createElement('div');
    div.id = "addBotao";
    div.innerHTML = `
    <a onClick="movimentarImagem()" class="btn btn-primary btn-md textoBranco"
    style="margin-right: 10px;"><i class="fas fa-arrows-alt"></i>
    Movimentar</a>
<a class="btn btn-primary btn-md textoBranco" href="adicionar_aplicacao"><i
        class="fas fa-plus-circle"></i> Adicionar</a>
    `
    document.getElementById("addBotao").remove();
    document.getElementById("botoes").appendChild(div);
    $("#getAplicacoes").sortable({
        disabled: true
    });

    $("#getAplicacoes").disableSelection();

}

//registra a nova posição de cada aplicação
function editarPosicao(id, posicao) {
    var http = new XMLHttpRequest();
    url = '/aplicacoes/' + id + '/' + posicao;
    http.open('PUT', url, true);
    http.send();
}

//incicializa o JQuery-ui sortable desabilitado para as imagens


//habilita o JQuery-ui sortable para as imagens
function movimentarImagem(id) {
    const div = document.createElement('div');
    div.id = "addBotao" + id;
    div.style = "float: right; margin-top: -50px; margin-bottom: 10px; cursor: pointer;"
    div.innerHTML = `
<a class="btn btn-primary btn-md botao-oco" style="margin-right: 10px;" href="admin_aplicacoes">
Cancelar</a>
<a class="btn btn-primary btn-md textoBranco" style="cursor: pointer; background-color: #32CD32 !important; border-color: #32CD32 !important" onClick="salvarImagem(`+ id + `)"><i class="fas fa-check-circle"></i> Salvar</a>
`
    document.getElementById("addBotao" + id).remove();
    document.getElementById("botoes" + id).appendChild(div);
    $(function () {
        $("#getImagens" + id).sortable({
            disabled: false
        });

        $("#getImagens" + id).disableSelection();
    });
}

//salva a nova ordem das imagens
function salvarImagem(id) {
    var sorted = $("#getImagens" + id).sortable("toArray");
    console.log(sorted);
    for (var i = 0; i < sorted.length; i++) editarPosicaoImagem(sorted[i], i + 1);
    window.alert("Imagens movidas com sucesso!");
    const div = document.createElement('div');
    div.id = "addBotao" + id;
    div.innerHTML = `
        <a onClick="movimentar()" class="btn btn-primary btn-md textoBranco"
    style="float: right; margin-top: -50px; margin-bottom: 10px; cursor: pointer;"><i class="fas fa-arrows-alt"></i>
    Movimentar</a>`
    document.getElementById("addBotao" + id).remove();
    document.getElementById("botoes" + id).appendChild(div);
    $("#getImagens" + id).sortable({
        disabled: true
    });

    $("#getImagens" + id).disableSelection();

}

//registra a nova posição de cada imagem
function editarPosicaoImagem(imagem_id, posicao) {
    var http = new XMLHttpRequest();
    url = '/imagens_aplicacoes/' + imagem_id + '/' + posicao;
    http.open('PUT', url, true);
    http.send();
}
