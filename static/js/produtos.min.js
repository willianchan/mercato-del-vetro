//função executada ao carregar a página, contém as funções que vão carregar os produtos e modais.
window.onload = function () {
    var produtos = getProd('/produtos');
    produtos = JSON.parse(produtos);
    console.log(produtos);
    for (produto in produtos) {
        this.addProduto(produtos[produto]);
        this.addModal(produtos[produto]);
    }
    //this.addAddButton();
};

//função responsável por fazer qualquer requisição GET ao banco de dados
function getProd(theUrl) {
    var xmlHttp = new XMLHttpRequest();
    xmlHttp.open("GET", theUrl, false); // false for synchronous request
    xmlHttp.send(null);
    return xmlHttp.responseText;
}

//adiciona cada produto na tela
function addProduto(produto) {
    div = document.createElement('div');
    div.className = 'col-md-4 col-sm-6 vidros-item';
    div.id = produto.id

    div.innerHTML = `
        <a class="vidros-link" data-toggle="modal" href="#produtoModal`+ produto.id + `">
            <div class="vidros-hover">
                <div class="vidros-hover-content">
                    <i class="fas fa-search-plus fa-3x"></i>
                </div>
            </div>
            <img class="img-fluid fit-image" src="`+ produto.imagem + `" alt="">
        </a>
        <div class="vidros-caption">
            <h4>`+ produto.titulo + `</h4>
            <a href="#expand`+ produto.id + `" data-toggle="collapse" style="color: black; font-size:15px; margin-top:-25px"><i class="fas fa-chevron-down"></i></a>

            <div id="expand`+ produto.id + `" class="collapse" style="">
                <div style="margin-top: 10px" class="row">
                <div class="col-md-6"><a onClick="editar(`+ produto.id + `,'` + produto.titulo + `',` + `'` + produto.texto + `',` + `'` + produto.imagem + `'` + `)" class="btn btn-primary btn-sm textoBranco" style="cursor: pointer;"><i class="fas fa-edit"></i> Editar</a></div>
                <div class="col-md-6"><a onClick="deletar(`+ produto.id + `)" class="btn btn-primary btn-sm textoBranco" style="cursor: pointer; background-color:#d11a2a !important; border-color:#d11a2a !important"><i class="fas fa-trash-alt"></i> Deletar</a></div>
            </div>
        </div>
        </div>
        
    `;

    document.getElementById('getProdutos').appendChild(div);
}

//cada produto abre um modal que contém várias imagens, essa função adiciona o modal de cada produto
function addModal(produto) {
    const div = document.createElement('div');
    div.innerHTML = `
    <div class="vidros-modal modal fade" id="produtoModal`+ produto.id + `" tabindex="-1" role="dialog" aria-hidden="true">
        <div class="close-modal" data-dismiss="modal">
            <i class="fas fa-times externo"></i>
        </div>
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="container">
                    <div class="modal-body modal-reduce-width">
                        <h2 class="text-uppercase">`+ produto.titulo + `</h2>
                        <img class="img-fluid d-block mx-auto vidros-moldura" src="`+ produto.imagem + `" alt="">
                        <p>`+ produto.texto + `</p>
                        <button class="btn btn-primary" data-dismiss="modal" type="button">
                            <i class="fas fa-times"></i>
                            Fechar</button>
                    </div>

                </div>
            </div>
        </div>
    </div>`
    document.getElementById('getModal').appendChild(div);
}

//envia os parâmetros de um produto para a tela de edição pela url
function editar(idv, titulov, textov, imagemv) {
    document.location.href = `editar_produto?id=` + idv + `&titulo=` + titulov + `&texto=` + textov + `&imagem=` + imagemv;
}

//deleta produtos
function deletar(id) {
    var url = "produtos/" + id;
    var xhr = new XMLHttpRequest();
    xhr.open("DELETE", url, true);
    if (confirm("Após deletado o produto não poderá ser recuperado. Deseja mesmo deletar?")) {
        txt = "You pressed OK!";
        xhr.onload = function () {
            var produtos = JSON.parse(xhr.responseText);
            if (xhr.readyState == 4 && xhr.status == "200") {
                console.table(produtos);
                document.location.href = "admin_produtos";
                alert("Produto deletado com sucesso!")
            } else {
                console.error(produtos);
            }
        }
        xhr.send(null);
    }

}

//incicializa o JQuery-ui sortable desabilitado
$(function () {
    $("#getProdutos").sortable({
        disabled: true
    });

    $("#getProdutos").disableSelection();
});

//habilita o JQuery-ui sortable
function movimentar() {
    const div = document.createElement('div');
    div.id = "addBotao";
    div.innerHTML = `
<a class="btn btn-primary btn-md botao-oco" style="margin-right: 10px;" href="admin_produtos">
Cancelar</a>
<a class="btn btn-primary btn-md textoBranco" style="cursor: pointer; background-color: #32CD32 !important; border-color: #32CD32 !important" onClick="salvar()"><i class="fas fa-check-circle"></i> Salvar</a>
`
    document.getElementById("addBotao").remove();
    document.getElementById("botoes").appendChild(div);
    $("#getProdutos").sortable("option", "disabled", false);
}

//salva a nova ordem dos produtos
function salvar() {
    var sorted = $("#getProdutos").sortable("toArray");
    for (var i = 0; i < sorted.length; i++) editarPosicao(sorted[i], i + 1);
    window.alert("Produtos movidos com sucesso!");
    const div = document.createElement('div');
    div.id = "addBotao";
    div.innerHTML = `
    <a onClick="movimentar()" class="btn btn-primary btn-md textoBranco"
    style="margin-right: 10px;"><i class="fas fa-arrows-alt"></i>
    Movimentar</a>
<a class="btn btn-primary btn-md textoBranco" href="adicionar_produto"><i
        class="fas fa-plus-circle"></i> Adicionar</a>`
    document.getElementById("addBotao").remove();
    document.getElementById("botoes").appendChild(div);
    $("#getProdutos").sortable({
        disabled: true
    });

    $("#getProdutos").disableSelection();

}

//registra a nova posição de cada aplicação
function editarPosicao(id, posicao) {
    var http = new XMLHttpRequest();
    url = '/produtos/' + id + '/' + posicao;
    http.open('PUT', url, true);
    http.send();
}

